var businessflowObject=function(){"use strict";var o="//127.0.0.1/sara.dd.ldsw/service/service_businessflow.asmx/",u=null,f=null,e=null,n=null,t=0,i=0,r={_pr_maintable_sys_id:"",loadChart:function(s){var h={appCodeString:"54",sysIdString:r._pr_maintable_sys_id};doAjaxFunction(o,"GetBusinessFlow",h,{success:function(o){n=new Function("","return "+o)();r.formatMessageJson();var h={chart:{renderTo:"div_container_businessflow",events:{load:function(){var e=this.renderer;$.each(n.activity.rows,function(t){var f="";f+=r.checkStringLength(n.activity.rows[t].activityname);f+="<br/>";f+=n.activity.rows[t].username;n.activity.rows[t].logcount>0&&(f+='<br/><a style="color:#f55a00;font-weight:bold">'+n.activity.rows[t].logcount+"条审核记录<\/a>");var o="#ffffff",s=1,i="",u="",h="false";n.activity.rows[t].iscurrent=="true"&&(o="#f7941d",s=6,h="true");switch(n.activity.rows[t].activityclass){case"1":n.activity.rows[t].workflownode!=""?(i="#3f84b5",u="#ffffff"):(i="#3f84b5",u="#ffffff");break;case"5":i="#047e4d";u="#ffffff";break;case"6":i="#8dbfd9";u="#ffffff";break;case"4":i="#ac4d47";u="#ffffff";break;case"7":i="#8dbfd9";u="#ffffff";break;case"2":i="#8dbfd9";u="#ffffff";break;case"3":i="#8dbfd9";u="#ffffff"}e.label(f,n.activity.rows[t].x,n.activity.rows[t].y).attr({fill:i,stroke:o,"stroke-width":s,padding:2,width:158,height:48,r:5,activityid:n.activity.rows[t].activityid,elementtype:"activity",ischecked:h}).css({color:u,fontSize:"12px"}).add().shadow(!1);n.activity.rows[t].issplitline&&e.path(["M",n.activity.rows[t].x+200,40,"L",n.activity.rows[t].x+200,750]).attr({"stroke-width":2,stroke:"silver",dashstyle:"dash"}).add()});$.each(n.connection.rows,function(r){var ct=f.get(n.connection.rows[r].fromactivityid),lt=f.get(n.connection.rows[r].toactivityid),c=u.get(n.connection.rows[r].fromactivityid),l=u.get(n.connection.rows[r].toactivityid),k="",d=2;switch(n.connection.rows[r].connectionclass){case"1":k="#fe8c00";d=1;break;case"2":k="#fe8c00";d=1;break;case"3":k="#fe8c00";d=1}if(c!=null&&l!=null&&ct!=null&&lt!=null){var v=parseInt(ct.split("_")[0]),p=parseInt(ct.split("_")[1]),y=parseInt(lt.split("_")[0]),w=parseInt(lt.split("_")[1]),ot=w/i*18+p/i*18+y/t*18+v/t*18,tt=y/t*8+v/t*8+w/i*8+p/i*8,g=w/i*2+p/i*2+y/t*2+v/t*2,it=y/t*9+v/t*9+w/i*9+p/i*9;if(w>p&&v==y)if(w-p==1){var a=parseInt(c.split("_")[0])+160,h=parseInt(c.split("_")[1])+25,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25;e.path(["M",a,h,"L",o,s,"L",o-5,h+5,"M",o,h,"L",o-5,s-5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(w-p)*5,nt=(w-p)/2,a=parseInt(c.split("_")[0])+75+ot-b,h=parseInt(c.split("_")[1]),o=parseInt(l.split("_")[0])+75-ot+b,s=parseInt(l.split("_")[1]),rt=a,ut=h-(10+it)-nt,ft=o,et=s-(10+it)-nt;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o+5,s-5,"M",o,s,"L",o-5,s-5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(p>w&&v==y)if(p-w==1){alert("向左的箭头隔一个");var a=parseInt(c.split("_")[0]),h=parseInt(c.split("_")[1])+25,o=parseInt(l.split("_")[0])+160,s=parseInt(l.split("_")[1])+25;e.path(["M",a,h,"L",o,s,"L",o+5,h-5,"M",o,h,"L",o+5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(p-w)*5,nt=(p-w)*1,a=parseInt(c.split("_")[0])+75-ot+b,h=parseInt(c.split("_")[1]),o=parseInt(l.split("_")[0])+75+ot-b,s=parseInt(l.split("_")[1]),rt=a,ut=h-(10+it)-nt,ft=o,et=s-(10+it)-nt;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o+5,s-5,"M",o,s,"L",o-5,s-5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(y>v&&p==w)if(y-v==1){var a=parseInt(c.split("_")[0])+75,h=parseInt(c.split("_")[1])+50,o=parseInt(l.split("_")[0])+75,s=parseInt(l.split("_")[1]);e.path(["M",a,h,"L",o,s,"L",a-5,s-5,"M",a,s,"L",a+5,s-5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(y-v)*5+Math.random()*5,nt=(y-v)*5,a=parseInt(c.split("_")[0]),h=parseInt(c.split("_")[1])+tt-nt+10,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+tt-nt+10,rt=a-(10+g)-b,ut=h,ft=o-(10+g)-b,et=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(v>y&&p==w)if(alert("向上的箭头"),v-y==1){var a=parseInt(c.split("_")[0])+75,h=parseInt(c.split("_")[1]),o=parseInt(l.split("_")[0])+75,s=parseInt(l.split("_")[1])+50;e.path(["M",a,h,"L",o,s,"L",a+5,s+5,"M",a,s,"L",a-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(y-v)*7+Math.random()*5,nt=(y-v)*5,a=parseInt(c.split("_")[0]),h=parseInt(c.split("_")[1])+tt+10-nt,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+tt+10-nt,rt=a-(10+g)-b,ut=h,ft=o-(10+g)-b,et=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(w>p&&y<v)if(w-p==1){var b=(v-y)*5,nt=(v-y)*5,a=parseInt(c.split("_")[0])+160,h=parseInt(c.split("_")[1])+25-tt+nt,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25-tt+nt,rt=o-g-5-b,ut=h,ft=o-g-5-b,et=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(w-p+(v-y))/2*5,nt=(w-p+(v-y))/2*5,a=parseInt(c.split("_")[0])+75+ot+b,h=parseInt(c.split("_")[1]),o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25-tt,rt=a,ut=h-(10+it)+nt,ft=o-g-5-b,et=h-(10+it)+nt,st=o-g-5-b,ht=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",st,ht,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(w>p&&y>v)if(w-p==1){var b=(y-v)*5,nt=(y-v)*5,a=parseInt(c.split("_")[0])+160,h=parseInt(c.split("_")[1])+tt+nt,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+tt+nt,rt=o-g-5-b,ut=h,ft=o-g-5-b,et=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else{var b=(y-v+(w-p))/2*5,nt=(y-v+(w-p))/2*5,a=parseInt(c.split("_")[0])+75+ot-b,h=parseInt(c.split("_")[1])+50,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25-tt,rt=a,ut=h+(10+it)-nt,ft=o-g-5-b,et=h+(10+it)-nt,st=o-g-5-b,ht=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",st,ht,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(w<p&&y<v){alert("向左上的箭头");var a=parseInt(c.split("_")[0])+75+ot,h=parseInt(c.split("_")[1])+50,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25-tt,rt=a,ut=h+(10+it),ft=o-g-5,et=h+(10+it),st=o-g-5,ht=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",st,ht,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}else if(w<p&&y>v){alert("向左下的箭头");var a=parseInt(c.split("_")[0])+75+ot,h=parseInt(c.split("_")[1])+50,o=parseInt(l.split("_")[0]),s=parseInt(l.split("_")[1])+25-tt,rt=a,ut=h+(10+it),ft=o-g-5,et=h+(10+it),st=o-g-5,ht=s;e.path(["M",a,h,"L",rt,ut,"L",ft,et,"L",st,ht,"L",o,s,"L",o-5,s-5,"M",o,s,"L",o-5,s+5]).attr({"stroke-width":d,stroke:k,fromactivityid:n.connection.rows[r].fromactivityid,toactivityid:n.connection.rows[r].toactivityid,elementtype:"connection"}).add()}}})}}},title:{text:" "},subtitle:{enabled:!1},credits:{enabled:!1},exporting:{enabled:!1}},c=new Highcharts.Chart(h);$('#div_container_businessflow g[elementtype="activity"]').css("cursor","pointer");$('#div_container_businessflow g[elementtype="activity"]').on("mouseover",function(){var f=$(this),t=f.attr("activityid"),o=f.find("rect"),s=$('path[fromactivityid="'+t+'"]'),h=$('path[toactivityid="'+t+'"]'),r;if(s.attr("stroke-width","2"),h.attr("stroke-width","2"),s.attr("stroke","#f55a00"),h.attr("stroke","#f55a00"),o.attr("stroke","#f55a00"),o.attr("stroke-width","2"),r=e.get(t),r){var c=u.get(t).split("_"),l=Number(c[0]),a=Number(c[1])+90,i=$("#div_logcontent_businessflow"),n="",v=r.split("~");$.each(v,function(t,i){n+='<div class="div-logcontent-div-businessflow">';var r=i.split("`");n+='<div class="div-logcontent-user-businessflow">';n+=r[0];n+="<\/div>";n+='<div class="div-logcontent-date-businessflow">';n+=r[1];n+="<\/div>";n+='<div class="div-logcontent-content-businessflow">';n+=r[2];n+="<\/div>";n+="<\/div>"});i.find("#div_logcontent1_businessflow").html(n);i.css("display","");i.css("left",l+"px");i.css("top",a+"px")}});$('#div_container_businessflow g[elementtype="activity"]').on("mouseout",function(){var t=$(this),i=t.attr("activityid"),n=t.find("rect"),r=$('path[fromactivityid="'+i+'"]'),u=$('path[toactivityid="'+i+'"]'),f;r.attr("stroke-width","1");u.attr("stroke-width","1");r.attr("stroke","#fe8c00");u.attr("stroke","#fe8c00");t.attr("ischecked")=="true"?(n.attr("stroke","#f7941d"),n.attr("stroke-width","6")):(n.attr("stroke","#ffffff"),n.attr("stroke-width","0"));f=$("#div_logcontent_businessflow");f.css("display","none")});$('#div_container_businessflow path[elementtype="connection"]').on("mouseover",function(){var n=$(this),t=n.attr("fromactivityid"),i=n.attr("toactivityid"),r=$('g[activityid="'+t+'"]>rect'),u=$('g[activityid="'+i+'"]>rect');t&&(r.attr("stroke-width","2"),r.attr("stroke","#f55a00"));i&&(u.attr("stroke-width","2"),u.attr("stroke","#f55a00"));n.attr("stroke-width","2");n.attr("stroke","#f55a00")});$('#div_container_businessflow path[elementtype="connection"]').on("mouseout",function(){var n=$(this),t=n.attr("fromactivityid"),u=n.attr("toactivityid"),f=$('g[activityid="'+t+'"]'),e=$('g[activityid="'+t+'"]'),i=$('g[activityid="'+t+'"]>rect'),r=$('g[activityid="'+u+'"]>rect');t&&(f.attr("ischecked")=="true"?(i.attr("stroke","#f7941d"),i.attr("stroke-width","3")):(i.attr("stroke","#ffffff"),i.attr("stroke-width","0")));u&&(e.attr("ischecked")=="true"?(r.attr("stroke","#f7941d"),r.attr("stroke-width","3")):(r.attr("stroke","#ffffff"),r.attr("stroke-width","0")));n.attr("stroke-width","1");n.attr("stroke","#fe8c00")});s.success()},fail:function(n){_blockMessage.show(r._serviceUrl+"GetBusinessFlow<br/>"+n,"fail")},error:function(n){_blockMessage.show(r._serviceUrl+"GetBusinessFlow<br/>"+n,"fail")}})},checkStringLength:function(n){return n.length>12?n.substring(0,12)+"...":n},formatMessageJson:function(){u=new hashMap;f=new hashMap;e=new hashMap;var s=6,r=0,o=0;$.each(n.activity.rows,function(i){var l=(r+1)*40+r*50,a=(o+1)*30+o*200,c,h,v;u.put(n.activity.rows[i].activityid,a+"_"+l);f.put(n.activity.rows[i].activityid,r+"_"+o);e.put(n.activity.rows[i].activityid,n.activity.rows[i].logcontent);n.activity.rows[i].x=a;n.activity.rows[i].y=l;i<n.activity.rows.length-1&&(n.activity.rows[i+1].workflownode!=""?n.activity.rows[i].workflownode!=""?(c=n.activity.rows[i+1].activityid.split("_").length,h=n.activity.rows[i].activityid.split("_").length,c==h&&h==2?(v=$.grep(n.connection.rows,function(t){return t.fromactivityid==n.activity.rows[i].activityid}),v.length>1?(r=1,o++):r<s?(r++,r>t&&(t=r)):(r=1,o++)):c==h&&h==3?r<s?(r++,r>t&&(t=r)):(r=1,o++):c>h&&h==2?(r=1,o++):c>h&&h==1?r<s?(r++,r>t&&(t=r)):(r=0,o++):c<h&&(r=1,o++)):(r=0,o++,n.activity.rows[i].issplitline=!0):n.activity.rows[i].workflownode!=""?(r=0,o++,n.activity.rows[i].issplitline=!0):r<s?(r=0,o++,r>t&&(t=r)):(r=0,o++))});i=o;var c=i*250,h=$(window).width()*.9,l=$(window).height();$("#div_businessflow").width(h-10);c<h?$("#div_container_businessflow").width(h):$("#div_container_businessflow").width(c)}};return r}();